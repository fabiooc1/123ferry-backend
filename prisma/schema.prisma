// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum PerfilTypes {
  CLIENTE
  ATENDENTE
  ADMINISTRADOR
}

model Perfil {
  id       Int         @id @default(autoincrement())
  nome     PerfilTypes
  usuarios Usuario[]

  @@map("perfils")
}

model Usuario {
  id                 Int      @id @default(autoincrement())
  nomeCompleto       String   @db.VarChar(100)
  email              String   @unique @db.VarChar(255)
  telefone           String   @unique @db.Char(15)
  cpf                String   @unique @db.Char(14)
  dataNascimento     DateTime @db.Date
  senhaCriptografada String   @db.VarChar(255)

  registradoEm DateTime @default(now())
  atualizadoEm DateTime @updatedAt

  perfilId Int
  perfil   Perfil @relation(fields: [perfilId], references: [id])

  viagensCriadas     Viagem[]
  passagensCompradas Passagem[] @relation("adquiridaPor")
  passagensAuditadas Passagem[] @relation("auditadaPor")

  @@index([nomeCompleto])
  @@map("usuarios")
}

model Ferry {
  id                   Int     @id @default(autoincrement())
  nome                 String  @unique @db.VarChar(100)
  maximoDePessoas      Int
  maximoDeVeiculosEmM2 Decimal @db.Decimal(10, 2)

  registradoEm DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  Viagens      Viagem[]

  @@index([nome])
  @@map("ferrys")
}

model Porto {
  id     Int    @id @default(autoincrement())
  nome   String @unique @db.VarChar(100)
  cidade String @db.VarChar(100)

  rotasOrigem  Rota[] @relation("rotasOrigem")
  rotasDestino Rota[] @relation("rotasDestino")

  @@index([nome, cidade])
  @@map("portos")
}

model Rota {
  id   Int    @id @default(autoincrement())
  nome String @unique @db.VarChar(100)

  origemId Int
  origem   Porto @relation(name: "rotasOrigem", fields: [origemId], references: [id])

  destinoId Int
  destino   Porto @relation(name: "rotasDestino", fields: [destinoId], references: [id])

  viagens Viagem[]

  @@unique([origemId, destinoId])
  @@index([nome, origemId, destinoId])
  @@map("rotas")
}

model Viagem {
  id Int @id @default(autoincrement())

  ferryId Int
  ferry   Ferry @relation(fields: [ferryId], references: [id])

  rotaId Int
  rota   Rota @relation(fields: [rotaId], references: [id])

  dataPartida DateTime
  dataChegada DateTime

  criadaPorId  Int
  criadaPor    Usuario  @relation(fields: [criadaPorId], references: [id])
  criadaEm     DateTime @default(now())
  atualizadaEm DateTime @updatedAt

  passagens Passagem[]

  @@index([ferryId, rotaId, dataPartida, dataChegada])
  @@map("viagens")
}

enum PassagemStatus {
  RESERVADA
  PAGA
  CANCELADA
}

model Passagem {
  id     Int            @id @default(autoincrement())
  codigo String         @unique @db.VarChar(255)
  status PassagemStatus @default(RESERVADA)

  adquiridaPorId Int
  adquiridaPor   Usuario @relation(name: "adquiridaPor", fields: [adquiridaPorId], references: [id])

  viagemId Int
  viagem   Viagem @relation(fields: [viagemId], references: [id])

  reservadaEm DateTime  @default(now())
  pagaEm      DateTime?
  canceladaEm DateTime?

  auditadaPorId Int?
  auditadaPor   Usuario? @relation(name: "auditadaPor", fields: [auditadaPorId], references: [id])

  passageiros PassagemPassageiro[]
  veiculos    PassagemVeiculo[]

  @@index([adquiridaPorId, viagemId])
  @@map("passagens")
}

model TipoPassageiro {
  id              Int                  @id @default(autoincrement())
  nome            String               @unique @db.VarChar(100)
  precoEmCentavos Int
  passageiros     PassagemPassageiro[]

  @@index([nome])
  @@map("tipos_passageiro")
}

model PassagemPassageiro {
  id Int @id @default(autoincrement())

  tipoId Int
  tipo   TipoPassageiro @relation(fields: [tipoId], references: [id])

  passagemId Int
  passagem   Passagem @relation(fields: [passagemId], references: [id])

  nomeCompleto   String   @db.VarChar(100)
  cpf            String   @db.Char(14)
  dataNascimento DateTime @db.Date

  precoPagoEmCentavos Int?
  PassagemVeiculo     PassagemVeiculo[]

  @@index([tipoId, passagemId, nomeCompleto, cpf])
  @@map("passagem_passageiros")
}

model VeiculoCategoria {
  id                      Int     @id @default(autoincrement())
  nome                    String  @unique @db.VarChar(100)
  tamanhoEmM2             Decimal @db.Decimal(10, 2)
  precoPassagemEmCentavos Int

  passagens PassagemVeiculo[]

  @@index([nome])
  @@map("veiculo_categoria")
}

model PassagemVeiculo {
  id Int @id @default(autoincrement())

  placa               String @db.VarChar(10)
  passagemId          Int
  motoristaId         Int
  veiculoCategoriaId  Int
  precoPagoEmCentavos Int?

  passagem         Passagem           @relation(fields: [passagemId], references: [id])
  veiculoCategoria VeiculoCategoria   @relation(fields: [veiculoCategoriaId], references: [id])
  motorista        PassagemPassageiro @relation(fields: [motoristaId], references: [id])

  @@index([passagemId, veiculoCategoriaId, motoristaId])
  @@map("passagem_veiculos")
}
